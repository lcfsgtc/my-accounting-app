<form action="/incomes" method="GET" id="incomesFilterForm">
    <div class="form-row">
        <div class="form-group col-md-3 col-sm-6">
            <label for="startDate">开始日期:</label>
            <input type="date" class="form-control" id="startDate" name="startDate" value="<%= typeof startDate !== 'undefined' ? startDate : '' %>">
        </div>
        <div class="form-group col-md-3 col-sm-6">
            <label for="endDate">结束日期:</label>
            <input type="date" class="form-control" id="endDate" name="endDate" value="<%= typeof endDate !== 'undefined' ? endDate : '' %>">
        </div>
        <div class="form-group col-md-3 col-sm-6">
            <label for="category">大类:</label>
            <input type="text" class="form-control" id="category" name="category" value="<%= typeof category !== 'undefined' ? category : '' %>">
            </div>
        <div class="form-group col-md-3 col-sm-6">
            <label for="subcategory">小类:</label>
            <input type="text" class="form-control" id="subcategory" name="subcategory" value="<%= typeof subcategory !== 'undefined' ? subcategory : '' %>">
            </div>
    </div>
    <div class="filter-buttons d-flex justify-content-start align-items-center mt-3">
        <input type="hidden" name="page" value="1">
        <button type="submit" class="btn btn-primary mr-2">筛选</button>
        <a href="/incomes/export<%=queryString%>" class="btn btn-secondary">导出</a>
    </div>
</form>

<div class="action-buttons d-flex justify-content-start align-items-center mt-4 mb-4">
    <a href="/incomes/add" class="btn btn-success mr-2">添加收入</a>
    <a href="/incomes/statistics" class="btn btn-info">收入统计</a>
</div>

<hr>
<h2>收入记录</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>描述</th>
                <th>金额</th>
                <th>大类</th>
                <th>小类</th>
                <th>日期</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <% if (incomes && incomes.length > 0) { %>
                <% incomes.forEach(income => { %>
                    <tr>
                        <td><%= income.description %></td>
                        <td><%= income.amount.toFixed(2) %></td>
                        <td><%= income.category %></td>
                        <td><%= income.subcategory %></td>
                        <td><%= new Date(income.date).toLocaleDateString('zh-CN') %></td>
                        <td>
                            <a href="/incomes/edit/<%= income._id %>" class="btn btn-sm btn-warning">编辑</a>
                            <form action="/incomes/delete/<%= income._id %>" method="POST" style="display: inline-block;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除吗？')">删除</button>
                            </form>
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="6" class="text-center">暂无收入记录。</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<% if (totalPages > 0) { %>
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4 flex-column flex-md-row">
        <div class="form-group d-flex align-items-center mb-3 mb-md-0">
            <label for="limitBottom" class="form-label mb-0 mr-2 text-nowrap">每页显示:</label>
            <select class="form-control form-control-sm w-auto" id="limitBottom" name="limit">
                <option value="5" <%= limit == 5 ? 'selected' : '' %>>5</option>
                <option value="10" <%= limit == 10 ? 'selected' : '' %>>10</option>
                <option value="20" <%= limit == 20 ? 'selected' : '' %>>20</option>
                <option value="50" <%= limit == 50 ? 'selected' : '' %>>50</option>
            </select>
        </div>

        <nav aria-label="Page navigation" class="mb-0">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link" href="<%= `/incomes?page=${currentPage - 1}&limit=${limit}&${queryString}` %>" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="<%= `/incomes?page=${i}&limit=${limit}&${queryString}` %>"><%= i %></a>
                    </li>
                <% } %>
                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link" href="<%= `/incomes?page=${currentPage + 1}&limit=${limit}&${queryString}` %>" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
<% } else if (incomes && incomes.length === 0) { %>
    <p class="alert alert-info text-center mt-5">暂无收入记录。</p>
<% } %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const limitBottomSelect = document.getElementById('limitBottom');
        limitBottomSelect.addEventListener('change', function() {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('limit', this.value);
            currentUrl.searchParams.set('page', 1); // Reset to first page when limit changes
            window.location.href = currentUrl.toString();
        });
    });
</script>