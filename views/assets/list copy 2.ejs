<%# views/assets/list.ejs - This file is rendered into layout.ejs %>

<form action="/assets" method="GET">
    <div class="row g-3 mb-4">
        <div class="col-md-4 col-lg-3">
            <label for="startDate" class="form-label">开始日期:</label>
            <input type="date" class="form-control" id="startDate" name="startDate" value="<%= typeof query.startDate !== 'undefined' ? query.startDate : '' %>">
        </div>
        <div class="col-md-4 col-lg-3">
            <label for="endDate" class="form-label">结束日期:</label>
            <input type="date" class="form-control" id="endDate" name="endDate" value="<%= typeof query.endDate !== 'undefined' ? query.endDate : '' %>">
        </div>
        <div class="col-md-4 col-lg-3">
            <label for="type" class="form-label">类型:</label>
            <%# Changed to select dropdown for better user experience based on distinct types %>
            <select class="form-select" id="type" name="type">
                <option value="">所有类型</option>
                <% if (distinctTypes && distinctTypes.length > 0) { %>
                    <% distinctTypes.forEach(t => { %>
                        <option value="<%= t %>" <%= query.type === t ? 'selected' : '' %>><%= t %></option>
                    <% }) %>
                <% } %>
            </select>
        </div>
        <div class="col-12 col-md-auto d-flex align-items-end mt-sm-0 mt-3">
            <button type="submit" class="btn btn-primary me-2"><i class="fas fa-filter"></i> 筛选</button>
            <a href="/assets/export<%=queryString ? '?' + queryString : ''%>" class="btn btn-secondary"><i class="fas fa-file-export"></i> 导出</a>
        </div>
    </div>
</form>

<div class="d-flex justify-content-start flex-wrap gap-2 mb-4">
    <a href="/assets/add" class="btn btn-success"><i class="fas fa-plus-circle"></i> 添加资产</a>
    <a href="/assets/statistics" class="btn btn-info"><i class="fas fa-chart-bar"></i> 资产统计</a>
    <%# Added import button and modal trigger %>
    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#importModal">
        <i class="fas fa-file-import"></i> 导入资产
    </button>
</div>

<hr>

<h2>资产记录</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>名称</th>
                <th>类型</th>
                <th>数量</th>
                <th>成本</th>
                <th>现值</th>
                <th>购买日期</th>
                <th>状况</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <% if (assets && assets.length > 0) { %>
                <% assets.forEach(asset => { %>
                    <tr>
                        <td><%= asset.name %></td>
                        <td><%= asset.type %></td>
                        <td><%= asset.quantity %></td>
                        <td><%= asset.cost %></td>
                        <td><%= asset.currentValue %></td>
                        <td><%= asset.purchaseDate ? new Date(asset.purchaseDate).toLocaleDateString() : '' %></td>
                        <td><%= asset.condition %></td>
                        <td class="text-nowrap">
                            <a href="/assets/edit/<%= asset._id %>" class="btn btn-sm btn-warning me-1"><i class="fas fa-edit"></i> 编辑</a>
                            <form action="/assets/delete/<%= asset._id %>" method="POST" style="display: inline;" onsubmit="return confirm('确定要删除吗？')">
                                <input type="hidden" name="_method" value="DELETE"> <%# Add method override for DELETE %>
                                <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i> 删除</button>
                            </form>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="8" class="text-center">暂无资产记录。</td> 
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<%# Pagination Controls %>
<% if (totalPages > 1) { %>
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                <a class="page-link" href="/assets?page=<%= currentPage - 1 %>&limit=<%= limit %><%= queryString ? '&' + queryString : '' %>" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <% 
            const maxPagesToShow = 5; // Adjust as needed
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            %>
            <% for (let i = startPage; i <= endPage; i++) { %>
                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="/assets?page=<%= i %>&limit=<%= limit %><%= queryString ? '&' + queryString : '' %>"><%= i %></a>
                </li>
            <% } %>
            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="/assets?page=<%= currentPage + 1 %>&limit=<%= limit %><%= queryString ? '&' + queryString : '' %>" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
<% } %>

<div class="mt-4 card shadow-sm">
    <div class="card-header bg-light">
        <h2 class="card-title mb-0">资产类型统计</h2>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            <% if (assetTypeCounts && Object.keys(assetTypeCounts).length > 0) { %>
                <% for (const type in assetTypeCounts) { %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <%= type %>
                        <span class="badge bg-primary rounded-pill">$<%= assetTypeCounts[type].toFixed(2) %></span>
                    </li>
                <% } %>
            <% } else { %>
                <li class="list-group-item text-muted">暂无统计数据。</li>
            <% } %>
        </ul>
        <p class="mt-3 fs-5">总成本: <span class="badge bg-secondary">$<%= totalCost %></span></p>
        <p class="fs-5">总现值: <span class="badge bg-success">$<%= totalCurrentValue %></span></p>
    </div>
</div>

<div class="d-flex justify-content-start mt-4">
    <a href="/" class="btn btn-secondary"><i class="fas fa-home"></i> 返回首页</a>
</div>

<%# Import Modal (moved here as it's part of the page content) %>
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">导入资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/assets/import" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <p class="text-muted">请上传 Excel (.xlsx, .xls) 或 CSV (.csv) 文件进行资产导入。</p>
                    <div class="mb-3">
                        <label for="assetFile" class="form-label">选择文件:</label>
                        <input class="form-control" type="file" id="assetFile" name="assetFile" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required>
                        <div class="form-text mt-2">
                            <p><strong>文件格式要求:</strong></p>
                            <ul>
                                <li><strong>必填字段:</strong> 名称, 购买日期, 成本, 数量, 现值</li>
                                <li><strong>可选字段:</strong> 类型, 状况, 序列号, 类别, 状态, 位置, 使用者, 描述</li>
                            </ul>
                            <p class="mb-0"><strong>示例 CSV/Excel 列名:</strong></p>
                            <p class="fst-italic text-break">名称,类型,数量,成本,现值,购买日期,状况,序列号,类别,状态,位置,使用者,描述</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">导入</button>
                </div>
            </form>
        </div>
    </div>
</div>