<%# views/assets/list.ejs - This file is rendered into layout.ejs %>

<form action="/assets" method="GET">
    <div class="row g-3 mb-4">
        <div class="col-md-4 col-lg-3">
            <label for="startDate" class="form-label">开始日期:</label>
            <input type="date" class="form-control" id="startDate" name="startDate" value="<%= typeof query.startDate !== 'undefined' ? query.startDate : '' %>">
        </div>
        <div class="col-md-4 col-lg-3">
            <label for="endDate" class="form-label">结束日期:</label>
            <input type="date" class="form-control" id="endDate" name="endDate" value="<%= typeof query.endDate !== 'undefined' ? query.endDate : '' %>">
        </div>
        <div class="col-md-4 col-lg-3">
            <label for="type" class="form-label">类型:</label>
            <select class="form-select" id="type" name="type">
                <option value="">所有类型</option>
                <% if (distinctTypes && distinctTypes.length > 0) { %>
                    <% distinctTypes.forEach(t => { %>
                        <option value="<%= t %>" <%= query.type === t ? 'selected' : '' %>><%= t %></option>
                    <% }) %>
                <% } %>
            </select>
        </div>
        <%# Removed 'limit' from here, it will be at the bottom %>
        <div class="col-12 col-md-auto d-flex align-items-end mt-sm-0 mt-3">
            <button type="submit" class="btn btn-primary me-2"><i class="fas fa-filter"></i> 筛选</button>
            <%
                // 构建导出链接的查询字符串，不包含 page 和 limit
                const exportQuery = { ...query };
                delete exportQuery.page;
                delete exportQuery.limit;
                const exportQueryString = Object.keys(exportQuery).length > 0 ? new URLSearchParams(exportQuery).toString() : '';
            %>
            <a href="/assets/export<%= exportQueryString ? '?' + exportQueryString : ''%>" class="btn btn-secondary"><i class="fas fa-file-export"></i> 导出</a>
        </div>
    </div>
</form>

<div class="d-flex justify-content-start flex-wrap gap-2 mb-4">
    <a href="/assets/add" class="btn btn-success"><i class="fas fa-plus-circle"></i> 添加资产</a>
    <a href="/assets/statistics" class="btn btn-info"><i class="fas fa-chart-bar"></i> 资产统计</a>
    <a href="/assets/export<%=queryString%>" class="btn btn-secondary">导出</a>
</div>

<hr>

<h2>资产记录</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>名称</th>
                <th>类型</th>
                <th>数量</th>
                <th>成本</th>
                <th>现值</th>
                <th>购买日期</th>
                <th>状况</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <% if (assets && assets.length > 0) { %>
                <% assets.forEach(asset => { %>
                    <tr>
                        <td><%= asset.name %></td>
                        <td><%= asset.type %></td>
                        <td><%= asset.quantity %></td>
                        <td><%= asset.cost %></td>
                        <td><%= asset.currentValue %></td>
                        <td><%= asset.purchaseDate ? new Date(asset.purchaseDate).toLocaleDateString() : '' %></td>
                        <td><%= asset.condition %></td>
                        <td class="text-nowrap">
                            <a href="/assets/edit/<%= asset._id %>" class="btn btn-sm btn-warning me-1"><i class="fas fa-edit"></i> 编辑</a>
                            <form action="/assets/delete/<%= asset._id %>" method="POST" style="display: inline;" onsubmit="return confirm('确定要删除吗？')">
                                <input type="hidden" name="_method" value="DELETE">
                                <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i> 删除</button>
                            </form>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="8" class="text-center">暂无资产记录。</td> 
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<%# Pagination and Items per page control - Adjusted position and layout %>
<% if (totalPages > 0) { %> <%# Show controls if there's at least one page %>
    <div class="d-flex flex-wrap justify-content-center justify-content-md-between align-items-center mt-4 p-3 border rounded" style="background-color: #e9ecef;"> <%# Simulate red box area with light background and border %>
        <%
            // Re-construct queryString for pagination links
            const pageQuery = { ...query };
            delete pageQuery.page; // Ensures 'page' is dynamically set by the link
            delete pageQuery.limit; // Ensures 'limit' is dynamically set by the dropdown or link
            const pageQueryString = Object.keys(pageQuery).length > 0 ? '&' + new URLSearchParams(pageQuery).toString() : '';
        %>

        <nav aria-label="Page navigation" class="mb-2 mb-md-0"> <%# Added margin for small screens %>
            <ul class="pagination pagination-sm mb-0"> <%# Use pagination-sm for smaller buttons %>
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link" href="/assets?page=<%= currentPage - 1 %>&limit=<%= limit %><%= pageQueryString %>" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="/assets?page=<%= i %>&limit=<%= limit %><%= pageQueryString %>"><%= i %></a>
                    </li>
                <% } %>
                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link" href="/assets?page=<%= currentPage + 1 %>&limit=<%= limit %><%= pageQueryString %>" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="d-flex align-items-center">
            <span class="me-2 text-nowrap">每页显示:</span>
            <select class="form-select form-select-sm" id="limitBottom" onchange="window.location.href='/assets?page=1&limit=' + this.value + '<%= pageQueryString %>'">
                <option value="5" <%= limit == 5 ? 'selected' : '' %>>5</option>
                <option value="10" <%= limit == 10 ? 'selected' : '' %>>10</option>
                <option value="20" <%= limit == 20 ? 'selected' : '' %>>20</option>
                <option value="50" <%= limit == 50 ? 'selected' : '' %>>50</option>
            </select>
            <span class="ms-3 text-nowrap">总共 <%= totalAssets %> 条记录</span> <%# Display total records %>
        </div>
    </div>
<% } %>


<div class="mt-4 card shadow-sm">
    <div class="card-header bg-light">
        <h2 class="card-title mb-0">资产类型统计</h2>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            <% if (assetTypeCounts && Object.keys(assetTypeCounts).length > 0) { %>
                <% for (const type in assetTypeCounts) { %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <%= type %>
                        <span class="badge bg-primary rounded-pill">$<%= assetTypeCounts[type].toFixed(2) %></span>
                    </li>
                <% } %>
            <% } else { %>
                <li class="list-group-item text-muted">暂无统计数据。</li>
            <% } %>
        </ul>
        <p class="mt-3 fs-5">总成本: <span class="badge bg-secondary">$<%= totalCost %></span></p>
        <p class="fs-5">总现值: <span class="badge bg-success">$<%= totalCurrentValue %></span></p>
    </div>
</div>

<div class="d-flex justify-content-start mt-4">
    <a href="/" class="btn btn-secondary"><i class="fas fa-home"></i> 返回首页</a>
</div>

<%# Import Modal (moved here as it's part of the page content) %>
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">导入资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/assets/import" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <p class="text-muted">请上传 Excel (.xlsx, .xls) 或 CSV (.csv) 文件进行资产导入。</p>
                    <div class="mb-3">
                        <label for="assetFile" class="form-label">选择文件:</label>
                        <input class="form-control" type="file" id="assetFile" name="assetFile" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required>
                        <div class="form-text mt-2">
                            <p><strong>文件格式要求:</strong></p>
                            <ul>
                                <li><strong>必填字段:</strong> 名称, 购买日期, 成本, 数量, 现值</li>
                                <li><strong>可选字段:</strong> 类型, 状况, 序列号, 类别, 状态, 位置, 使用者, 描述</li>
                            </ul>
                            <p class="mb-0"><strong>示例 CSV/Excel 列名:</strong></p>
                            <p class="fst-italic text-break">名称,类型,数量,成本,现值,购买日期,状况,序列号,类别,状态,位置,使用者,描述</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">导入</button>
                </div>
            </form>
        </div>
    </div>
</div>